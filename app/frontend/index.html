<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FCC AI Assistant MVP</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { DEFAULT: "#0f172a", light: "#1e293b", accent: "#0ea5e9" },
            bank:  { bg: "#f8fafc", card: "#ffffff", border: "#e2e8f0" }
          }
        }
      }
    }
  </script>
  <!-- Markdown + Sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <style>
    /* Subtle, always-visible scrollbar (desktop) */
    .scrolly::-webkit-scrollbar { width: 10px; }
    .scrolly::-webkit-scrollbar-track { background: #f1f5f9; }
    .scrolly::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
    .scrolly:hover::-webkit-scrollbar-thumb { background: #94a3b8; }
    /* Firefox */
    .scrolly { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }
    /* Typography for bot messages */
    .prose-chat :where(p,ul,ol,pre,code,blockquote,h1,h2,h3){ margin:0.25rem 0; }
    .prose-chat pre{ background:#0b1220; color:#e2e8f0; padding:.75rem; border-radius:.5rem; overflow:auto; }
    .prose-chat code{ background:#f1f5f9; padding:.1rem .3rem; border-radius:.25rem; }
  </style>
</head>
<body class="min-h-screen bg-bank-bg text-slate-900">
  <!-- Toast -->
  <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="bg-red-600 text-white px-4 py-2 rounded shadow"></div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-bank-border">
    <div class="mx-auto max-w-4xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <svg class="h-6 w-6 text-brand-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 3l8 4v6c0 5-3.5 7.5-8 8-4.5-.5-8-3-8-8V7l8-4z" stroke-width="1.5"/>
          <path d="M8.5 12l2.5 2.5 4.5-4.5" stroke-width="1.5"/>
        </svg>
        <h1 class="text-sm sm:text-base font-semibold">FCC AI Assistant MVP</h1>
      </div>

      <!-- Right side (auth-dependent) -->
      <div class="flex items-center gap-3">
        <!-- Model select (hidden until authenticated) -->
        <div id="model_wrap" class="hidden">
          <select id="model" class="text-sm border border-bank-border rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-brand-accent">
            <option value="base">Base model</option>
            <option value="tuned">Tuned model</option>
          </select>
        </div>

        <!-- User info + logout (hidden until authenticated) -->
        <div id="user_wrap" class="hidden items-center gap-2">
          <span id="whoami" class="text-xs sm:text-sm text-slate-600"></span>
          <button id="logout" type="button" class="text-xs sm:text-sm px-3 py-2 rounded-lg border border-bank-border hover:bg-slate-50">
            Sign out
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-4xl px-4 flex flex-col min-h-[calc(100vh-64px)]">
    <!-- Unauthenticated: login card + request access -->
    <section id="auth_card" class="flex-1 flex items-center justify-center">
      <div class="w-full max-w-md bg-bank-card border border-bank-border rounded-2xl shadow-sm p-6">
        <h2 class="text-lg font-semibold mb-2">Welcome</h2>
        <p class="text-sm text-slate-600 mb-6">
          The FCC AI Assistant is in private beta testing.
          Please message
          <a class="text-brand-accent underline" href="https://www.linkedin.com/in/jeanvoigt/" target="_blank" rel="noopener">Jean</a>
          for access.
        </p>

        <div class="space-y-3">
          <div>
            <label for="email" class="block text-sm text-slate-700 mb-1">Email</label>
            <input id="email" type="email" autocomplete="username"
                   class="w-full rounded-lg border border-bank-border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-accent"
                   placeholder="email@domain.com">
          </div>
          <div>
            <label for="password" class="block text-sm text-slate-700 mb-1">Password</label>
            <input id="password" type="password" autocomplete="current-password"
                   class="w-full rounded-lg border border-bank-border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-accent"
                   placeholder="••••••••">
          </div>
          <button id="signin" type="button"
                  class="w-full bg-brand-accent text-white rounded-lg py-2.5 font-medium hover:opacity-95 transition">
            Sign in
          </button>
        </div>
      </div>
    </section>

    <!-- Authenticated: chat layout -->
    <section id="app" class="hidden flex-1 flex flex-col">
      <!-- Messages scroll area -->
      <div id="chat" class="flex-1 overflow-y-auto scrolly py-4 space-y-4">
        <!-- messages get appended here -->
      </div>

      <!-- Composer (bottom) -->
      <div class="sticky bottom-0 bg-white border-t border-bank-border">
        <form id="composer" class="max-w-4xl mx-auto px-0 py-3 flex items-end gap-2">
          <textarea id="query" rows="1" placeholder="Type a question ..."
                    class="flex-1 resize-y max-h-40 rounded-xl border border-bank-border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-brand-accent"></textarea>
          <button id="send" type="submit"
                  class="shrink-0 bg-brand-accent text-white px-4 py-3 rounded-xl font-medium hover:opacity-95 transition">
            Send
          </button>
        </form>
      </div>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const api_base = location.origin;
      const $ = (id) => document.getElementById(id);

      const chatEl = $("chat");
      const toast = $("toast");
      let session_token = null;

      const showToast = (msg, ms = 3000) => {
        if (!toast) return;
        toast.firstElementChild.textContent = msg;
        toast.classList.remove("hidden");
        setTimeout(() => toast.classList.add("hidden"), ms);
      };

      // --- Helpers ---
      const scrollToBottom = () => { if (chatEl) chatEl.scrollTop = chatEl.scrollHeight; };

      // Create a message bubble. Returns the inner element so we can mutate text live.
      function addMsg(content, who = "bot", isMarkdown = false) {
        if (!chatEl) return document.createElement("div");
        const wrapper = document.createElement("div");
        const bubble = document.createElement("div");

        wrapper.className = `px-2 flex ${who === "user" ? "justify-end" : "justify-start"}`;
        bubble.className = [
          "max-w-[85%] rounded-2xl px-4 py-3 shadow",
          who === "user" ? "bg-sky-50 border border-sky-100" : "bg-white border border-bank-border"
        ].join(" ");

        let inner;
        if (isMarkdown) {
          const html = DOMPurify.sanitize(marked.parse(content, { breaks: true }));
          inner = document.createElement("div");
          inner.className = "prose prose-sm prose-slate prose-chat max-w-none";
          inner.innerHTML = html;
        } else {
          inner = document.createElement("div");
          inner.className = "msg whitespace-pre-wrap";
          inner.textContent = content;
        }
        bubble.appendChild(inner);
        wrapper.appendChild(bubble);
        chatEl.appendChild(wrapper);
        scrollToBottom();
        return inner;
      }

      function addContexts(ctxs = []) {
        if (!chatEl || !ctxs.length) return;
        const wrapper = document.createElement("div");
        wrapper.className = "px-2 flex justify-start";
        const card = document.createElement("div");
        card.className = "max-w-[85%] bg-white border border-bank-border rounded-2xl px-4 py-3 shadow";
        const title = document.createElement("div");
        title.className = "text-xs font-semibold text-slate-600 mb-2";
        title.textContent = `Context (${ctxs.length})`;
        card.appendChild(title);

        const list = document.createElement("div");
        list.className = "space-y-2";
        ctxs.forEach(c => {
          const row = document.createElement("div");
          row.className = "text-xs text-slate-700 border-l-2 border-slate-200 pl-3";
          row.innerHTML = `<div class="font-medium">${c.doc ?? ""}</div>
                           <div class="text-slate-500">chunk ${c.chunk_id ?? "?"} • score ${c.score != null ? Number(c.score).toFixed(3) : "-"}</div>
                           <div class="mt-1 text-slate-600">${(c.text || "").slice(0, 800)}</div>`;
          list.appendChild(row);
        });
        card.appendChild(list);
        wrapper.appendChild(card);
        chatEl.appendChild(wrapper);
        scrollToBottom();
      }

      function showSignedIn(email) {
        $("model_wrap")?.classList.remove("hidden");
        $("user_wrap")?.classList.remove("hidden");
        const who = $("whoami"); if (who) who.textContent = email || "";
        $("auth_card")?.classList.add("hidden");
        $("app")?.classList.remove("hidden");
        $("query")?.focus();
      }

      function showSignedOut() {
        $("model_wrap")?.classList.add("hidden");
        $("user_wrap")?.classList.add("hidden");
        const who = $("whoami"); if (who) who.textContent = "";
        $("auth_card")?.classList.remove("hidden");
        $("app")?.classList.add("hidden");
        session_token = null;
      }

      // autosize textarea
      const autoSize = (ta) => { if (!ta) return; ta.style.height = "auto"; ta.style.height = Math.min(ta.scrollHeight, 320) + "px"; };
      $("query")?.addEventListener("input", (e) => autoSize(e.target));

      // --- Auth ---
      $("signin")?.addEventListener("click", async (ev) => {
        ev.preventDefault();
        const email = $("email")?.value?.trim();
        const password = $("password")?.value;
        if (!email || !password) { showToast("Enter email and password."); return; }

        try {
          console.log("login: POST /api/login");
          const res = await fetch(`${api_base}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
          });
          const data = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
          session_token = data.token;
          console.log("login: ok");
          showSignedIn(email);
        } catch (e) {
          console.error("login error:", e);
          showToast("Sign-in failed: " + (e.message || e));
        }
      });

      $("logout")?.addEventListener("click", async (ev) => {
        ev.preventDefault();
        try {
          if (session_token) {
            await fetch(`${api_base}/api/logout`, {
              method: "POST",
              headers: { "Authorization": `Bearer ${session_token}` }
            });
          }
        } catch (e) {
          console.warn("logout error:", e);
        } finally {
          showSignedOut();
        }
      });

      // --- Heartbeat during in-flight requests ---
      let hbTimer = null;
      const startHB = (rid) => {
        if (hbTimer) clearInterval(hbTimer);
        hbTimer = setInterval(async () => {
          try {
            const r = await fetch(`${api_base}/api/health`);
            console.log(`[hb ${rid}] -> ${r.ok ? "ok" : r.status}`);
          } catch (e) {
            console.log(`[hb ${rid}] error`, e);
          }
        }, 2000);
      };
      const stopHB = () => { if (hbTimer) clearInterval(hbTimer); hbTimer = null; };

      // --- Streaming chat via SSE ---
      async function sendChatStream(q) {
        const rid = crypto.randomUUID();

        addMsg(q, "user", false);
        const thinkingEl = addMsg("Thinking…\n", "bot", false);

        startHB(rid);

        const modelSel = $("model")?.value || "base"; // "base" | "tuned"
        const url = `${api_base}/api/chat/stream?rid=${encodeURIComponent(rid)}&token=${encodeURIComponent(session_token||"")}&model=${encodeURIComponent(modelSel)}&top_k=5&q=${encodeURIComponent(q)}`;
        const es = new EventSource(url);

        es.addEventListener("route", (ev) => {
          try {
            const data = JSON.parse(ev.data);
            const modelShort = (data.model || "").split("/").pop() || "n/a";
            thinkingEl.textContent = `Plan: domain=${data.domain}, top_k=${data.top_k}, tuned=${data.use_tuned ? "yes" : "no"} • model=${modelShort}\n\n`;
          } catch {}
        });

        es.addEventListener("retrieve", (ev) => {
          try {
            const data = JSON.parse(ev.data);
            const args = data.args || {};
            thinkingEl.textContent += `Retrieving context (top_k=${args.top_k ?? "?"})…\n\n`;
          } catch {}
          scrollToBottom();
        });

        es.addEventListener("delta", (ev) => {
          try {
            const data = JSON.parse(ev.data);
            thinkingEl.textContent += data.text || "";
          } catch {}
          scrollToBottom();
        });

        es.addEventListener("final", (ev) => {
          stopHB();
          try {
            const data = JSON.parse(ev.data);
            const container = thinkingEl.parentElement?.parentElement;
            if (container) container.remove();
            addMsg(data.answer || "No answer.", "bot", true);
            if (data.contexts) addContexts(data.contexts);
          } catch {
            thinkingEl.textContent += "\n\n[done]";
          }
          es.close();
        });

        es.onerror = (e) => {
          console.warn("SSE error", e);
          stopHB();
          es.close();
          thinkingEl.textContent += "\n\n[stream error]";
        };
      }

      // Submit handler
      $("composer")?.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        if (!session_token) { showToast("Please sign in first."); return; }

        const ta = $("query");
        const q = (ta?.value || "").trim();
        if (!q) return;

        // Restrict non-sanctions topics as per your app behavior
        if (/\bAML\b/i.test(q) || /money\s+laundering/i.test(q)) {
          addMsg("For now, this assistant is trained to answer **sanctions-related** queries only. Please rephrase your question accordingly.", "bot", true);
          if (ta) { ta.value = ""; autoSize(ta); }
          return;
        }

        if (ta) { ta.value = ""; autoSize(ta); }
        await sendChatStream(q);
      });

      // Enter to send (Shift+Enter for newline)
      $("query")?.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          $("composer")?.dispatchEvent(new Event("submit"));
        }
      });
    });
  </script>
</body>
</html>
